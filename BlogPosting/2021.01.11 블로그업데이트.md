# 게시판 만들기 예제 반복숙달 눈감고 뚝딱가즈아~
https://ganzicoder.tistory.com/65

node.js 로 게시판 뚝딱 뚝딱 만들어보기 가장 기본인 CRUD를 mysql 과 express 를 사용해서 만들수있는 

 

가장 좋은 트레이닝법이라고 생각한다 그래도 게시판정도는 뚝딱해놓고 나중에 기능들을 추가해서

 

나만의 프로젝트를 만든다고 생각해보자

 

npm 설치목록 requirements

express 

mysql

bodyparser

ejs

 
```
// app.js

var express = require('express');
var ejs = require('ejs')
var mysqlRouter = require('./routes/mysql')
var app = express();
var bodyParser = require('body-parser')

app.set('view engine', 'ejs'); // 뷰엔진으로 npm 설치한 ejs 사용
app.set('views', './views/') // view 파일들은 .view 에 잇다
app.use(bodyParser.urlencoded({extended: true})); // post 할때 자꾸 cannot property  에러나서 찾아보니 router 경로 지정 전에 bodyparser 미들웨어 설정해야함
app.use(bodyParser.json());


var formRouter = require('./routes/form');
var boardRouter = require('./routes/board')
app.use('/form', formRouter);
app.use('/mysql', mysqlRouter);
app.use('/board', boardRouter);  //항상 추가해주자 라우터를 만들면 app.js 메인파일에 추가 항상!


app.listen(3000);
```

routes 폴더 만들어서 routes 분기해주고 

views 폴더 만들어서 ejs 파일들 분기해주기

 

필요 routes

board.js

form.js

mysql.js 는 사실상 있어도그만 없어도 그만인듯 싶지만 

 

혹여나 db 폴더를 따로 생성하여 접속과 db 정보 관련하여 파일을 생성 분리하여 관리할거면 필히 만들고 

 

필자는 연결이 제대로 되엇는지 안되엇는지 (연동) 확인하기위해 만들었음

 
```
// form.js

var express = require('express'); // require로 express 사용하겠음
var router = express.Router(); // express 프레임워크 라우터를 사용하기위해 변수선언

router.get('/', function(req, res, next){ // 라우터는 URI 요청에 응답하는 방식을 말함  
    res.render('form', {
        name : '보더코딩',  // ejs 파일 의 <%%> 태그안에 담길 변수들
        blog : '보더코딩의 블로그',
        homepage : '보더코딩의 홈페이지'
    }); // res.render 는 해당 'view' 파일을 지정할수잇음
});

router.post('/', function(req,res,next){ // post 요청에 응당하는 router
    res.json(req.body) // 요청받은데이터를 json 함수로 response 하겟음
});
```

module.exports = router; // 전역으로 해당 라우터를 사용하게해줌

```
// form.ejs

<!DOCTYPE html>
<html>
<head>
    <title>게시판 연습중</title>
</head>
<body>
    <h1>이름</h1>
      <p> <%= name %></p>
    <h1>블로그</h1>
        <p> <%= blog %></p>
    <h1>홈페이지</h1>
     <p> <%= homepage %></p>
</body>
</html
<form id="Form" action="/form" method="post">
    <table width="400">
        <tr>
            <th>이름</th>
            <td><input type="text" name="name" id="name" size="10" maxLength="10"></td> 
        </tr>
        <tr>
            <th>블로그</th>
            <td><input type="text" name="name" id="name" size="10" maxLength="10"></td> 
        </tr>
        <tr>
            <th>홈페이지</th>
            <td><input type="text" name="name" id="name" size="10" maxLength="10"></td> 
        </tr>
        <tr>
            <th>전송</th>
            <td><input type="submit"></td> 
        </tr>
    </table>
</form>
```

사이좋게 form 부터 뷰파일과 routes 파일 맹글어주깅

 
```
// mysql.js

var express = require('express');
var router = express.Router();
var mysql = require('mysql');

router.get('/', function(req,res,next){

    var connection = mysql.createConnection({ // createConnection 데이터베이스 설정 입력 
        host : 'localhost',
        port : 3306,
        user : 'root',
        password : '비번넣으세요',
        database : '테이블명넣으세요'
    });

    connection.connect(function(err) { // connect 함수로 접속과 동시에 연결설정에 대한 확인 
        if(err) {
            res.render('mysql', {connect : '연결실패', err:err});
            console.error(err);
            throw err;
        } else {
            res.render('mysql', {connect : '연결성공', err : '없음'})
        }
    });
    connection.end();
});

module.exports = router;

```

```
// mysql.ejs

<!DOCTYPE html>
<html>
<head>
    <title>mysql 연결 테스트</title>
</head>
<body>
    <h1>연결여부 </h1>
    <p> <%=connect%></p>
    <h1>오류여부</h1>
    <p> <%=err%></p>
</body>
</html>
```
 

node.js 와 mysql 연동해주는과정에서 연동이 되엇는지 안되엇는지 

눈으로 확인하고싶어서 직접만들었음 백프로 확신하는분은 js 파일만 만들어서 그냥 console 에 찍기만해도

무방하다 

 
```
// 대망의 board.js


var express = require('express');
var router = express.Router();
var mysql = require('mysql');  // db 폴더를 만들어서 conn 과 info 를 만들어 코드의 길이를 최대한줄일수도있다고한다

var connection = mysql.createConnection({ // createConnection 데이터베이스 설정 입력 
    host : 'localhost',
    port : 3306,
    user : 'root',
    password : '비밀번호넣으세용',
    database : '테이블명넣으세용'
});


router.get('/list', function(req, res, next) {  // list/1 이 아니라  /list 로만 라우팅됫을때 /list/1 로 보내준다
    res.redirect('/board/list/1');
});

router.get('/list/:page', function(req, res, next){ // board/list/page숫자 형식으로 받을거
    var page = req.params.page; // :page 로 맵핑할 req 값을 가져온다
    var sql = "SELECT idx, name, title, date_format(modidate, '%Y-%m-%d %H:%i:%s') modidate, " +   
        "date_format(regdate,'%Y-%m-%d %H:%i:%s') regdate from board";
        connection.query(sql, function(err, rows){  // select 쿼리문 날린 데이터를 rows 변수에 담는다 오류가 있으면 err
        if(err) console.error("err : " + err);
        res.render('list.ejs', {title : '게시판 리스트', rows:rows});
    });
});

router.get('/write', function(req, res, next){  // board/write 로 접속하면 글쓰기페이지로 이동
    res.render('write', {title : "게시판 글쓰기"})
});

router.post('/write', function(req, res, next){
    var name = req.body.name;                   
    var title = req.body.title;
    var content = req.body.content;
    var passwd = req.body.passwd;
    var datas = [name, title, content, passwd]; // 모든데이터를 배열로 묶기
    // req 객체로 body 속성에서 input 파라미터 가져오기
    var sql = "insert into board(name, title, content, regdate, modidate, passwd,hit) values(?,?,?,now(),now(),?,0)";  // ? 는 매개변수
    connection.query(sql, datas, function(err,rows){ // datas 를 매개변수로 추가
        if (err) console.error("err : " + err);
        res.redirect('/board/list')
    });
});

router.get('/read/:idx', function(req, res, next){ // board/read/idx숫자 형식으로 받을거
    var idx = req.params.idx; // :idx 로 맵핑할 req 값을 가져온다
    var sql = "SELECT idx, name, title, date_format(modidate, '%Y-%m-%d %H:%i:%s') modidate, " +   
        "date_format(regdate,'%Y-%m-%d %H:%i:%s') regdate, hit from board where idx=?";
        connection.query(sql,[idx], function(err, rows){  // 한개의 글만조회하기때문에 마지막idx에 매개변수를 받는다
        if(err) console.error("err : " + err);
        res.render('read', {title : '글 상세보기', rows:rows[0]}); // 첫번째행 한개의데이터만 랜더링 요청
    });
});



router.post('/update', function(req, res, next){
    var idx = req.body.idx;
    var name = req.body.name;
    var title = req.body.title;
    var content = req.body.content;
    var passwd = req.body.passwd;
    var datas = [idx, name, title, content, passwd]; // 변수설정한 값을 datas 에 배열화

    var sql = "UPDATE board set name=?, title=?, content=? ,modidate=now() where idx=? and passwd=?"; // id 값과 비밀번호를 조건절로 걸엇음
    connection.query(sql, datas, function(err, result){
        if (err) console.error(err);
        if(result.affectedRows == 0) //affectedRows  해당쿼리로 변경된수의 행 불러오기 0이면 업데이트 되지않으므로 비밀번호가 틀린것임
        { res.send("<script>alert('비밀번호가 일치하지않습니다');history.back();</script>")
        } else {
            res.redirect('/board/read/' + idx);
        }
    });
});

router.get('/page/:page', function(req, res, next){ // 게시글 리스트에 :page가 추가된것임
    var page = req.params.page; // 현재 페이지는 params 을 req 요청받아옴
    var sql =  "select idx, name, title, date_format(modidate,'%Y-%m-%d %H:%i:%s') modidate, " +
    "date_format(regdate,'%Y-%m-%d %H:%i:%s') regdate,hit from board";  // select 구절 그대로

    connection.query(sql, function(err, rows){
        if (err) console.err("err : " + err);
        res.render('page', {title : '글목록', rows:rows, page:page, length:rows.length-1, page_num:10, pass:true}); 
        // length 데이터 전체넘버 랜더링,-1을 한이유는 db에서는1부터지만 for문에서는 0부터 시작 ,page_num: 한페이지에 보여줄 갯수
        console.log(rows.length-1);
    });
});

router.post('/delete', function(req,res,next){
    var idx = req.body.idx;
    var passwd = req.body.passwd;
    var datas = [idx, passwd];

    var sql = "delete from board where idx=? and passwd=?"; // 업데이트 수정과 거의 비슷한 쿼리문
    connection.query(sql, datas, function(err, result){
        if(err) console.error(err);
        if(result.affectedRows == 0){
            res.send("<script>alert('패스워드가 일치하지 않습니다.');history.back();</script>");
        } else {
            res.redirect('/board/list');
        }
    });
});
// 삭제기능은 수정기능과 거의 비슷함 
module.exports = router;
```
 

장난아니게 긴거같지만 쉽게 딱 설명하면 각각의 router. get ,post 든 각각의 기능들을 추가한거고 

그에 맞는 mysql 쿼리문을 날린다고 생각하면된다 

 

생각외로 수정과 삭제는 쿼리문이 거의 비슷하다 

 

상세페이지도 조회와 거의 비슷 전체조회를 하느냐 한가지만 조회 하느냐가 차이가 크다

 

상세인척하는조회랄까

 
```
// list.ejs

<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
</head>
<body>
<h1><%= title %></h1>
<a href="/board/write">글쓰기</a>
<table border="1">
    <tr>
        <td>번호</td>
        <td>작성자</td>
        <td>제목</td>
        <td>조회수</td>
        <td>수정일</td>
        <td>등록일</td>
    </tr>
    <%
    for(var i=0; i<rows.length; i++)  
    {
    %>
    <tr>
        <td><%=rows[i].idx%></td>
        <td><%=rows[i].name%></td>
        <td><a href="/board/read/<%=rows[i].idx%>"><%=rows[i].title%></a></td>
        <td><%=rows[i].hit%></td>
        <td><%=rows[i].modidate%></td>
        <td><%=rows[i].regdate%></td>
    </tr>
    <%}%>
</table>
</body>
</html>
```

등록된 게시물 리스트를 반환해주는 route  인데 여기서 페이징을 추가하면

 
```
// page.ejs (리스트와 거의 비슷하지만 페이징기능이 추가됨)

<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
</head>
<body>
<h1><%= title %></h1>
<a href="/board/write">글쓰기</a>
<table border="1">
    <tr>
        <td>번호</td>
        <td>작성자</td>
        <td>제목</td>
        <td>조회수</td>
        <td>수정일</td>
        <td>등록일</td>
    </tr>
    <%
    for(var i = (page * page_num) - page_num; i < (page * page_num); i++) {
    if(i > length){
        i++;
    }else{
        var data = rows[i]
    %>
    <tr>
        <td><%= i + 1 %></td>
        <td><%= data.name %></td>
        <td><a href="/board/read/<%= data.idx %>"><%= data.title %></a></td>
        <td><%= data.hit %></td>
        <td><%= data.modidate %></td>
        <td><%= data.regdate %></td>
    </tr>
    <% }
    }
    %>
    <tr>
        <td colspan="6">
            <%
            for(var j = 0; j < rows.length / page_num; j++){
            %>
            [<a href="/board/page/<%= j + 1 %>"><%= j + 1 %></a>]
            <%
            }
            %>
        </td>
    </tr>
</table>
</body>
</html>
```

페이징 기능이 추가된 리스트를 만들기위해 router.get ('/page/:page' 로 시작하는 api 참조)

 
```
// read.ejs


<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
</head>
<body>
<h1><%= title %></h1>
<form action="/board/update" method="post">
    <table border="1">
        <input type="hidden" name="idx" value="<%=rows.idx%>"/>
        <tr>
            <td>작성자</td>
            <td><input type="text" name="name" id="name" value="<%=rows.name%>" required/></td>
        </tr>
        <tr>
            <td>제목</td>
            <td><input type="text" name="title" id="title" value="<%=rows.title%>" required/></td>
        </tr>
        <tr>
            <td>내용</td>
            <td><textarea name="content" id="content" cols="30" rows="10" required><%=rows.content%></textarea></td>
        </tr>
        <tr>
            <td>패스워드</td>
            <td><input type="password" name="passwd" id="passwd" required/></td>
        </tr>
        <tr>
            <td>변경일</td>
            <td><%=rows.modidate%></td>
        </tr>
        <tr>
            <td>등록일</td>
            <td><%=rows.regdate%></td>
        </tr>
        <tr>
            <td>조회수</td>
            <td><%=rows.hit%></td>
        </tr>
        <tr>
            <td colspan="2">
                <button type="submit">글 수정</button>
                <a href="/board/list">목록</a>
            </td>
        </tr>
    </table>
</form>
</body>
</html>
```

```
// write.ejs


<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
</head>
<body>
<h1><%= title %></h1>
<form action="/board/write" method="post">
    <table border="1">
        <tr>
            <td>작성자</td>
            <td><input type="text" name="name" id="name" required/></td>
        </tr>
        <tr>
            <td>제목</td>
            <td><input type="text" name="title" id="title" required/></td>
        </tr>
        <tr>
            <td>내용</td>
            <td><textarea name="content" id="content" cols="30" rows="10" required></textarea></td>
        </tr>
        <tr>
            <td>패스워드</td>
            <td><input type="password" name="passwd" id="passwd" required/></td>
        </tr>
        <tr>
            <td colspan="2">
                <button type="submit">글쓰기</button>
            </td>
        </tr>
    </table>
</form>
</body>
</html>
```
 

board.js 에서 기능들을 만들고 쿼리문을 사용해서 

그 만든쿼리문을 바탕으로 ejs 뷰파일에서 틀을 만든다 라고 생각하는게 나는 이해하기가 가장쉬웟다

 

글쓰기 같은경우 get 과 post 를 두가지를 만들었다는점

 

상세페이지도 board.js 에선 get 요청이지만 

 

ejs 에선 post 요청을 한것 등 

 

기본적인것만 흐름을 이해하고 넘어가보도록하자 

 

오늘은 두시간걸리지만

 

나중엔 한시간 

 

그나중엔 삼십분

 

나중엔 손으로 공책에 적을날을 기대하며 

 

반복숙달 가즈아아앙~~~ 

 

결과물은 직접해보시라고 안올립니다~~

 