# Node.js 이벤트 기반 비동기 방식
https://ganzicoder.tistory.com/84

노드가 좋은 성능을 발휘할수있는 것은 비동기 이벤트 기반 아키텍처 와

구글의 V8 자바스크립트 엔진을 이용하기 때문

 

 

쓰레드 기반 과 비동기 이벤트기반

 

대부분의 애플리케이션에선 Blocking I/O 를 사용했고

이 때문에 멀티 쓰레드를 사용할수밖에 없었다

멀티 쓰레드는 개발자 입장에서는 직관적이고 멀티 태스킹을 위해서는 어쩔수 없지만

네트워크에서 동시에 대규모 요청을 동시에 처리하는데에는 부적절

 

 

Blocking I/O

 

"하나의 프로세스가 어떤 자원을 사용할때 그 자원을 다른 프로세스가 점유하고있다면,

그 프로세스가 그 자원의 사용을 다 할때까지 기다려야한다"

를 의미한다

애플리케이션이 운영체제의 커널에게 파일을 읽기위해 시스템 콜이라는 형태로 

요청을 보낸다

커널은 파일을 읽기위한 동작을 수행하기 시작하고 애플리케이션은 커널이 파일을

다 읽을 때까지 기다린다 

일반적으로 이상태를 애플리케이션은 아무것도하지않는 상태가 된다.

 

멀티쓰레드

 

일반적으로 하나의 프로세스가 하나의 요청에 대해 대응하고 그 일을 처리하게되는데

만약 웹서버와 같이 다수의 요청이 들어오게 된다면 멀티 쓰레드라는개념을 사용할수 밖에 없다

 

멀티쓰레드는 쓰레드 여러개가 동시에 실행되어 요청을 처리한다는 개념이다

이것은 CPU 의 시분할이라는 개념으로 설명가능

 

쓰레드로 인해 발생하는문제

 

멀티 쓰레드를 통해 복수의 요청으로 인해 발생하는 공유 문제는 해결 가능

 

CPU사용에 대해 스케줄링통해 멀티 쓰레딩을 하더라고 하나의 CPU를 다수의 

쓰레드가 사용하고자 한다면 CPU 도 하나의 자원이기 때문에

여러 쓰레드들이 CPU를 점유하기 위해 기다릴수 밖에없는것이 근본적인 문제

실질적인 문제는 뭐가 있을까?

 

Blocking I/O 자체가 발생시키는 쓰레드 지연

I/O 요청을 하고 응답이 올때까지 아무것도 하징낳고 시간을 낭비한다

 

스케줄링을 위한 처리 시간과 문맥전환 비용 발생

쓰레드를 분배하여 사용하려면 스케줄링 그자체도 CPU 를 이용한 작업이 필요하고

쓰레드간의 전환을 위해서 쓰레드를 나중에 복귀시킬때를 대비하여 전환하기 직전을 저장하고

이또한 CPU의 연산이 필요한작업

쓰레드가 많아질수록 문맥전환에 따른 성능저하가 발생

이때문에 쓰레드들을 별도로 관리하거나 더 작은단위로 쪼개어 VM 등으로 실제 쓰레드로 

분배하는 방식 의 대안이 등장

 

 

싱글 쓰레드와 이벤트 기반의 비동기 I/O 처리

 

노드는 이러한 문제들을 싱글쓰레드와 이벤트깁반의 비동기 I/O 처리로 해결하고

그성능을 끌어올릴수 있도록 하는 비동기 프로그래밍 모델을 제공한다

싱글쓰레드를 가진 노드는 I/O 작업이 시작되면 I/O처리에대한 응답을 기다리지않고

바로 다음 작업을 실행한다

대신 I/O 작업이 종료되면 이벤트를 발생시키고 이벤트는 해당 프로세스의 이벤트 큐에 등록되게 된다

노드로 개발된 프로세스는 이벤트 큐에 등록된 새로운 이벤트를 감지 해당 이벤트시 수행하여 할 작업을 실행한다

 

이벤트루프

 

이벤트 루프는 작업을 요청하면서 그 작업이 완료되었을때 어떤 작업을 진행할지에 대한 콜백함수를

지정하여 동작이 완료되었을때 해당 콜백함수를 실행하는 방식을 말한다

 

클라가 웹서버에 HTTP 형식으로 요청하면,서버에선 이벤트루프가 계속 돌다가 이를 감지

알맞은 작업을 워커 쓰레드를 생성하여 실행한다

이때 이벤트루프는 해당워커 쓰레드가 작업을 마친뒤 그 결과와 함께

응답할때까지 기다리는것이 아니라 루프로 복귀형 다른 요청을 기다린다

 

이벤트루프는 어떤요청이 발생하면 그작업의 쓰레드 실행만을 일으킨다

이후 작업을 할당받았던 해당 쓰레드가 모든작업을 마치면 미리전달받은 콜백함수를 실행하도록 

이벤트 루프로 응답하게되면 

이벤트 루프는 이것을  실행 클라에게 결과를 보여준다

 